generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  user_id                 String                  @id @default(uuid()) @db.Uuid
  user_session_id         String?                 @unique @db.VarChar(255)
  selected_language       String?                 @db.VarChar(20)
  selected_gender         String?                 @db.VarChar(30)
  selected_state          String?                 @db.VarChar(100)
  selected_lga            String?                 @db.VarChar(100)
  selected_age_group      String?                 @db.VarChar(20)
  selected_marital_status String?                 @db.VarChar(30)
  main_menu_option        String?                 @db.VarChar(50)
  current_step            String?                 @db.VarChar(50)
  current_fpm_method      String?                 @db.VarChar(100)
  current_concern_type    String?                 @db.VarChar(100)
  user_intention          String?                 @db.VarChar(100)
  created_at              DateTime                @default(now()) @db.Timestamptz(6)
  updated_at              DateTime                @updatedAt @db.Timestamptz(6)
  last_active_at          DateTime                @default(now()) @db.Timestamptz(6)
  preferredLanguage       String?                 @map("preferred_language")
  satisfactionScore       Float?                  @map("satisfaction_score")
  totalConversations      Int                     @default(0) @map("total_conversations")
  chat_sessions           ChatSession[]
  conversation_analytics  ConversationAnalytics[]
  fpm_interactions        FpmInteraction[]
  user_clinic_referrals   UserClinicReferral[]
  user_responses          UserResponse[]
  conversation_queue      ConversationQueue[]
  conversations           Conversation[]

  @@index([selected_state, selected_lga])
  @@index([last_active_at])
  @@index([created_at])
  @@map("users")
}

model ChatSession {
  session_id               String                 @id @default(uuid()) @db.Uuid
  user_id                  String?                @db.Uuid
  user_session_id          String?                @db.VarChar(255)
  session_start_time       DateTime               @default(now()) @db.Timestamptz(6)
  session_end_time         DateTime?              @db.Timestamptz(6)
  total_messages_count     Int                    @default(0)
  session_duration_minutes Int?
  session_completed        Boolean                @default(false)
  session_outcome          String?                @db.VarChar(100)
  final_step_reached       String?                @db.VarChar(50)
  user_agent               String?
  ip_address               String?                @db.Inet
  device_type              String?                @db.VarChar(20)
  created_at               DateTime               @default(now()) @db.Timestamptz(6)
  user                     User?                  @relation(fields: [user_id], references: [user_id])
  conversation_analytics   ConversationAnalytics?
  fpm_interactions         FpmInteraction[]
  user_clinic_referrals    UserClinicReferral[]
  user_responses           UserResponse[]
  conversations            Conversation[]

  @@index([user_id])
  @@index([user_session_id])
  @@index([session_start_time])
}

model ChatStateSession {
  session_id      String   @id @default(uuid()) @db.Uuid
  user_session_id String   @unique @db.VarChar(255)
  chat_state      String
  last_activity   DateTime @default(now()) @db.Timestamptz(6)
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @updatedAt @db.Timestamptz(6)

  @@index([user_session_id])
  @@index([last_activity])
  @@map("chat_state_sessions")
}

model Conversation {
  conversation_id         String                  @id @default(uuid()) @db.Uuid
  session_id              String?                 @db.Uuid
  user_id                 String?                 @db.Uuid
  message_text            String
  message_type            String                  @db.VarChar(10)
  message_source          String?                 @default("typed") @db.VarChar(20)
  chat_step               String?                 @db.VarChar(50)
  widget_name             String?                 @db.VarChar(100)
  selected_option         String?                 @db.VarChar(200)
  message_delay_ms        Int?
  has_widget              Boolean                 @default(false)
  widget_options          String[]
  created_at              DateTime                @default(now()) @db.Timestamptz(6)
  message_sequence_number Int
  status                  ConversationStatus      @default(ACTIVE)
  escalatedAt             DateTime?               @map("escalated_at")
  escalationStatus        String?                 @map("escalation_status") @db.VarChar(50)
  escalationReason        String?                 @map("escalation_reason")
  assignedAgentId         String?                 @map("assigned_agent_id")
  assignedAt              DateTime?               @map("assigned_at")
  completedAt             DateTime?               @map("completed_at")
  satisfaction            SatisfactionLevel?
  satisfactionScore       Float?                  @map("satisfaction_score")
  feedback                String?
  responseTime            Float?                  @map("response_time")
  channelId               String?                 @map("channel_id") @db.Uuid
  user_responses          UserResponse[]
  agentMessages           AgentMessage[]
  channelMessages         ChannelMessage[]
  assignment              ConversationAssignment?
  queue                   ConversationQueue?
  channel                 Channel?                @relation(fields: [channelId], references: [id])
  session                 ChatSession?            @relation(fields: [session_id], references: [session_id])
  user                    User?                   @relation(fields: [user_id], references: [user_id])

  @@index([session_id, user_id])
  @@index([created_at])
  @@index([status])
  @@index([channelId])
  @@map("conversations")
}

model UserResponse {
  response_id          String         @id @default(uuid()) @db.Uuid
  user_id              String?        @db.Uuid
  session_id           String?        @db.Uuid
  conversation_id      String?        @db.Uuid
  previous_response_id String?        @db.Uuid
  response_category    String         @db.VarChar(50)
  response_type        String         @db.VarChar(50)
  question_asked       String?
  user_response        String
  response_value       String?        @db.VarChar(200)
  widget_used          String?        @db.VarChar(100)
  available_options    String[]
  step_in_flow         String?        @db.VarChar(50)
  is_initial_response  Boolean        @default(true)
  created_at           DateTime       @default(now()) @db.Timestamptz(6)
  conversation         Conversation?  @relation(fields: [conversation_id], references: [conversation_id])
  previous_response    UserResponse?  @relation("UserResponseToPrevious", fields: [previous_response_id], references: [response_id])
  next_responses       UserResponse[] @relation("UserResponseToPrevious")
  session              ChatSession?   @relation(fields: [session_id], references: [session_id])
  user                 User?          @relation(fields: [user_id], references: [user_id])
}

model FpmInteraction {
  interaction_id              String       @id @default(uuid()) @db.Uuid
  user_id                     String?      @db.Uuid
  session_id                  String?      @db.Uuid
  fpm_flow_type               String?      @db.VarChar(50)
  current_fpm_method          String?      @db.VarChar(100)
  interested_fpm_method       String?      @db.VarChar(100)
  fpm_duration_preference     String?      @db.VarChar(50)
  contraception_type          String?      @db.VarChar(50)
  emergency_product           String?      @db.VarChar(50)
  prevention_duration         String?      @db.VarChar(50)
  selected_method             String?      @db.VarChar(100)
  satisfaction_level          String?      @db.VarChar(50)
  switch_reason               String?      @db.VarChar(200)
  stop_reason                 String?      @db.VarChar(200)
  important_factors           String[]
  kids_in_future              String?      @db.VarChar(20)
  timing_preference           String?      @db.VarChar(50)
  menstrual_flow_preference   String?      @db.VarChar(100)
  provided_information        String?
  next_action                 String?      @db.VarChar(100)
  clinic_referral_needed      Boolean      @default(false)
  human_agent_requested       Boolean      @default(false)
  created_at                  DateTime     @default(now()) @db.Timestamptz(6)
  contraception_choice        String?      @db.VarChar(100)
  dailypills_stop_period      String?      @db.VarChar(100)
  emergency_prevention_choice String?      @db.VarChar(100)
  fpm_concern_type            String?      @db.VarChar(100)
  gel_lubricant_choice        String?      @db.VarChar(100)
  implant_removal_duration    String?      @db.VarChar(100)
  improve_intimacy_choice     String?      @db.VarChar(100)
  injection_stop_period       String?      @db.VarChar(100)
  iud_removal_duration        String?      @db.VarChar(100)
  main_menu_option            String?      @db.VarChar(50)
  other_method_choices        String?      @db.VarChar(100)
  pregnancy_trial             String?      @db.VarChar(100)
  prevention_choice           String?      @db.VarChar(100)
  side_effects                String?      @db.VarChar(100)
  switch_method               String?      @db.VarChar(100)
  user_session_id             String?      @db.VarChar(255)
  has_medical_conditions      String?      @db.VarChar(20)
  medical_screening_shown     String?      @db.VarChar(20)
  requires_clinic_referral    Boolean      @default(false)
  session                     ChatSession? @relation(fields: [session_id], references: [session_id])
  user                        User?        @relation(fields: [user_id], references: [user_id])
}

model ClinicLocation {
  clinic_id             String               @id @default(uuid()) @db.Uuid
  clinic_name           String               @db.VarChar(200)
  clinic_type           String?              @db.VarChar(50)
  state                 String               @db.VarChar(100)
  lga                   String               @db.VarChar(100)
  city                  String?              @db.VarChar(100)
  address               String?
  landmark              String?              @db.VarChar(200)
  phone_number          String?              @db.VarChar(20)
  website               String?              @db.VarChar(200)
  services_offered      String[]
  fpm_methods_available String[]
  consultation_fee      Decimal?             @db.Decimal(10, 2)
  operating_hours       String?
  latitude              Decimal?             @db.Decimal(10, 8)
  longitude             Decimal?             @db.Decimal(11, 8)
  is_active             Boolean              @default(true)
  verified_at           DateTime?            @db.Timestamptz(6)
  created_at            DateTime             @default(now()) @db.Timestamptz(6)
  updated_at            DateTime             @updatedAt @db.Timestamptz(6)
  referrals             UserClinicReferral[]
}

model UserClinicReferral {
  referral_id           String          @id @default(uuid()) @db.Uuid
  user_id               String?         @db.Uuid
  session_id            String?         @db.Uuid
  clinic_id             String?         @db.Uuid
  referral_reason       String?         @db.VarChar(200)
  user_concern          String?         @db.VarChar(200)
  recommended_service   String?         @db.VarChar(100)
  referral_provided_at  DateTime        @default(now()) @db.Timestamptz(6)
  user_contacted_clinic Boolean         @default(false)
  user_visited_clinic   Boolean         @default(false)
  visit_confirmed_at    DateTime?       @db.Timestamptz(6)
  follow_up_needed      Boolean         @default(false)
  follow_up_completed   Boolean         @default(false)
  follow_up_notes       String?
  clinic                ClinicLocation? @relation(fields: [clinic_id], references: [clinic_id])
  session               ChatSession?    @relation(fields: [session_id], references: [session_id])
  user                  User?           @relation(fields: [user_id], references: [user_id])
}

model ConversationAnalytics {
  analytics_id                  String       @id @default(uuid()) @db.Uuid
  session_id                    String?      @unique @db.Uuid
  user_id                       String?      @db.Uuid
  steps_completed               String[]
  widgets_interacted_with       String[]
  flows_attempted               String[]
  total_user_messages           Int          @default(0)
  total_bot_messages            Int          @default(0)
  total_button_clicks           Int          @default(0)
  total_typed_responses         Int          @default(0)
  session_abandonment_point     String?      @db.VarChar(50)
  information_provided          String[]
  goals_achieved                String[]
  unresolved_concerns           String[]
  satisfaction_rating           Int?
  average_response_time_seconds Decimal?     @db.Decimal(10, 2)
  errors_encountered            String[]
  created_at                    DateTime     @default(now()) @db.Timestamptz(6)
  session                       ChatSession? @relation(fields: [session_id], references: [session_id])
  user                          User?        @relation(fields: [user_id], references: [user_id])
}

model Admin {
  id            String          @id @default(uuid()) @db.Uuid
  name          String          @db.VarChar(100)
  email         String          @unique @db.VarChar(255)
  password      String          @db.VarChar(255)
  role          AdminRole       @default(ADMIN)
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  profileImage  String?         @map("profile_image")
  configChanges ChatbotConfig[] @relation("ConfigUpdatedBy")

  @@map("admins")
}

model Agent {
  id                    String                   @id @default(uuid()) @db.Uuid
  name                  String                   @db.VarChar(100)
  email                 String                   @unique @db.VarChar(255)
  password              String                   @db.VarChar(255)
  status                AgentStatus              @default(OFFLINE)
  maxChats              Int                      @default(5) @map("max_chats")
  currentChats          Int                      @default(0) @map("current_chats")
  isOnline              Boolean                  @default(false) @map("is_online")
  lastActiveAt          DateTime?                @map("last_active_at") @db.Timestamptz(6)

  // Location fields for smart assignment
  state                 String?                  @db.VarChar(100)
  lga                   String?                  @db.VarChar(100)
  latitude              Float?
  longitude             Float?

  // Languages the agent can communicate in (comma-separated)
  languages             String?                  @db.VarChar(255)

  createdAt             DateTime                 @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime                 @updatedAt @map("updated_at") @db.Timestamptz(6)
  channelAssignments    AgentChannelAssignment[]
  sentMessages          AgentMessage[]
  assignedConversations ConversationAssignment[]
  shifts                AgentShift[]
  availabilityWindows   AgentAvailability[]
  agentNotifications    AgentNotification[]

  @@map("agents")
}

model ConversationAssignment {
  id             String           @id @default(uuid()) @db.Uuid
  conversationId String           @unique @map("conversation_id") @db.Uuid
  agentId        String           @map("agent_id") @db.Uuid
  assignedAt     DateTime         @default(now()) @map("assigned_at")
  completedAt    DateTime?        @map("completed_at")
  status         AssignmentStatus @default(ACTIVE)
  priority       Priority         @default(NORMAL)
  agent          Agent            @relation(fields: [agentId], references: [id])
  conversation   Conversation     @relation(fields: [conversationId], references: [conversation_id])

  @@map("conversation_assignments")
}

model ConversationQueue {
  id             String       @id @default(uuid()) @db.Uuid
  conversationId String       @unique @map("conversation_id") @db.Uuid
  userId         String       @map("user_id") @db.Uuid
  priority       Priority     @default(NORMAL)
  queuedAt       DateTime     @default(now()) @map("queued_at")
  estimatedWait  Int?         @map("estimated_wait_minutes")
  status         QueueStatus  @default(WAITING)
  conversation   Conversation @relation(fields: [conversationId], references: [conversation_id])
  user           User         @relation(fields: [userId], references: [user_id])

  @@map("conversation_queue")
}

model AgentMessage {
  id             String       @id @default(uuid()) @db.Uuid
  conversationId String       @map("conversation_id") @db.Uuid
  agentId        String       @map("agent_id") @db.Uuid
  messageText    String       @map("message_text")
  sentAt         DateTime     @default(now()) @map("sent_at") @db.Timestamptz(6)
  isRead         Boolean      @default(false) @map("is_read")
  readAt         DateTime?    @map("read_at") @db.Timestamptz(6)
  agent          Agent        @relation(fields: [agentId], references: [id])
  conversation   Conversation @relation(fields: [conversationId], references: [conversation_id])

  @@map("agent_messages")
}

model ChatbotConfig {
  id             String         @id @default(uuid()) @db.Uuid
  key            String         @unique @db.VarChar(255)
  value          String
  category       ConfigCategory
  language       String         @default("en") @db.VarChar(10)
  updatedBy      String?        @map("updated_by") @db.Uuid
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  updatedByAdmin Admin?         @relation("ConfigUpdatedBy", fields: [updatedBy], references: [id])

  @@map("chatbot_config")
}

model ConversationLog {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  action         String
  performedById  String   @map("performed_by_id")
  details        Json?
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([conversationId])
  @@map("conversation_logs")
}

model Channel {
  id               String                   @id @default(uuid()) @db.Uuid
  name             String                   @db.VarChar(100)
  type             ChannelType
  isActive         Boolean                  @default(true) @map("is_active")
  color            String                   @db.VarChar(20)
  icon             String                   @db.VarChar(50)
  description      String?
  autoAssignment   Boolean                  @default(true) @map("auto_assignment")
  maxWaitTime      Int?                     @map("max_wait_time")
  operatingStart   String?                  @map("operating_start") @db.VarChar(5)
  operatingEnd     String?                  @map("operating_end") @db.VarChar(5)
  platformConfig   Json?                    @map("platform_config")
  createdAt        DateTime                 @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime                 @updatedAt @map("updated_at") @db.Timestamptz(6)
  agentAssignments AgentChannelAssignment[]
  channelMessages  ChannelMessage[]
  metrics          ChannelMetrics[]
  conversations    Conversation[]

  @@map("channels")
}

model AgentChannelAssignment {
  id         String   @id @default(uuid()) @db.Uuid
  agentId    String   @map("agent_id") @db.Uuid
  channelId  String   @map("channel_id") @db.Uuid
  isActive   Boolean  @default(true) @map("is_active")
  maxChats   Int      @default(5) @map("max_chats")
  priority   Int      @default(1)
  assignedAt DateTime @default(now()) @map("assigned_at") @db.Timestamptz(6)
  agent      Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  channel    Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([agentId, channelId])
  @@map("agent_channel_assignments")
}

model AgentShift {
  id        String    @id @default(uuid()) @db.Uuid
  agentId   String    @map("agent_id") @db.Uuid
  dayOfWeek DayOfWeek @map("day_of_week")
  startTime String    @map("start_time") @db.VarChar(5) // HH:MM format
  endTime   String    @map("end_time") @db.VarChar(5)   // HH:MM format
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  agent     Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@map("agent_shifts")
}

model AgentAvailability {
  id        String    @id @default(uuid()) @db.Uuid
  agentId   String    @map("agent_id") @db.Uuid
  startDate DateTime? @map("start_date") @db.Date
  endDate   DateTime? @map("end_date") @db.Date
  startTime DateTime  @map("start_time") @db.Timestamptz(6)
  endTime   DateTime  @map("end_time") @db.Timestamptz(6)
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  agent     Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@map("agent_availability")
}

model ConversationHandoff {
  id             String    @id @default(uuid()) @db.Uuid
  conversationId String    @map("conversation_id") @db.Uuid
  fromAgentId    String?   @map("from_agent_id") @db.Uuid
  toAgentId      String?   @map("to_agent_id") @db.Uuid
  fromType       String?   @map("from_type") @db.VarChar(20)
  toType         String?   @map("to_type") @db.VarChar(20)
  reason         String?   @db.Text
  inactivityTime Int?      @map("inactivity_time")
  metadata       Json?
  handoffAt      DateTime  @default(now()) @map("handoff_at") @db.Timestamptz(6)
  completedAt    DateTime? @map("completed_at") @db.Timestamptz(6)

  @@map("conversation_handoffs")
}

model AdminNotification {
  id        String             @id @default(uuid()) @db.Uuid
  adminId   String?            @map("admin_id") @db.Uuid
  type      NotificationType
  title     String             @db.VarChar(255)
  message   String             @db.Text
  status    NotificationStatus @default(UNREAD)
  createdAt DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  readAt    DateTime?          @map("read_at") @db.Timestamptz(6)

  @@map("admin_notifications")
}

model AgentNotification {
  id             String             @id @default(uuid()) @db.Uuid
  agentId        String             @map("agent_id") @db.Uuid
  conversationId String?            @map("conversation_id") @db.Uuid
  type           NotificationType
  title          String             @db.VarChar(255)
  message        String             @db.Text
  status         NotificationStatus @default(UNREAD)
  createdAt      DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  readAt         DateTime?          @map("read_at") @db.Timestamptz(6)
  agent          Agent              @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@map("agent_notifications")
}

model ChannelMessage {
  id             String        @id @default(uuid()) @db.Uuid
  channelId      String        @map("channel_id") @db.Uuid
  conversationId String        @map("conversation_id") @db.Uuid
  externalId     String?       @map("external_id") @db.VarChar(255)
  messageType    String        @map("message_type") @db.VarChar(20)
  content        String
  metadata       Json?
  status         MessageStatus @default(SENT)
  deliveredAt    DateTime?     @map("delivered_at") @db.Timestamptz(6)
  readAt         DateTime?     @map("read_at") @db.Timestamptz(6)
  createdAt      DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  channel        Channel       @relation(fields: [channelId], references: [id])
  conversation   Conversation  @relation(fields: [conversationId], references: [conversation_id])

  @@index([channelId, createdAt])
  @@map("channel_messages")
}

model ChannelMetrics {
  id                  String   @id @default(uuid()) @db.Uuid
  channelId           String   @map("channel_id") @db.Uuid
  date                DateTime @db.Date
  totalConversations  Int      @default(0) @map("total_conversations")
  activeConversations Int      @default(0) @map("active_conversations")
  avgResponseTime     Decimal? @map("avg_response_time") @db.Decimal(10, 2)
  avgWaitTime         Decimal? @map("avg_wait_time") @db.Decimal(10, 2)
  satisfactionScore   Decimal? @map("satisfaction_score") @db.Decimal(3, 2)
  totalMessages       Int      @default(0) @map("total_messages")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  channel             Channel  @relation(fields: [channelId], references: [id])

  @@unique([channelId, date])
  @@map("channel_metrics")
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  MODERATOR
}

enum AgentStatus {
  ONLINE
  OFFLINE
  BUSY
  AWAY
}

enum AssignmentStatus {
  ACTIVE
  COMPLETED
  TRANSFERRED
  ABANDONED
}

enum QueueStatus {
  WAITING
  ASSIGNED
  CANCELLED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum AssignmentStrategy {
  AUTO
  MANUAL
  ROUND_ROBIN
  LEAST_BUSY
}

enum ConversationStatus {
  ACTIVE
  WAITING_FOR_AGENT
  AGENT_ASSIGNED
  RESOLVED
  COMPLETED
  ABANDONED
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum NotificationType {
  ASSIGNMENT
  MESSAGE
  ESCALATION
  ESCALATION_REQUEST
  AGENT_ASSIGNED
  SYSTEM
  WARNING
}

enum NotificationStatus {
  UNREAD
  READ
  DISMISSED
}

enum SatisfactionLevel {
  VERY_SATISFIED
  SATISFIED
  NEUTRAL
  DISSATISFIED
  VERY_DISSATISFIED
}

enum ConfigCategory {
  MESSAGES
  OPTIONS
  SYSTEM
  UI_TEXT
  PROMPTS
}

enum ChannelType {
  WHATSAPP
  WEB
  MESSENGER
  VOICE
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
  FAILED
}

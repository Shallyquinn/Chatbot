generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core User and Session Models

model User {
  user_id             String   @id @default(uuid()) @db.Uuid
  user_session_id     String   @unique @db.VarChar(255)

  // Demographics
  selected_language        String?  @db.VarChar(20)
  selected_gender          String?  @db.VarChar(30)
  selected_state           String?  @db.VarChar(100)
  selected_lga             String?  @db.VarChar(100)
  selected_age_group       String?  @db.VarChar(20)
  selected_marital_status  String?  @db.VarChar(30)

  // Session state
  main_menu_option    String?  @db.VarChar(50)
  current_step        String?  @db.VarChar(50)
  current_fpm_method  String?  @db.VarChar(100)
  current_concern_type String? @db.VarChar(100)
  user_intention      String?  @db.VarChar(100)

  // Timestamps
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @updatedAt @db.Timestamptz(6)
  last_active_at  DateTime @default(now()) @db.Timestamptz(6)

  // Agent system fields
  preferredLanguage     String?   @map("preferred_language")
  satisfactionScore     Float?    @map("satisfaction_score")
  totalConversations    Int       @default(0) @map("total_conversations")

  // Relations
  chat_sessions          ChatSession[]
  conversations          Conversation[]
  user_responses         UserResponse[]
  fpm_interactions       FpmInteraction[]
  user_clinic_referrals  UserClinicReferral[]
  conversation_analytics ConversationAnalytics[]
  conversation_queue     ConversationQueue[]

  @@index([selected_state, selected_lga])
  @@index([last_active_at])
  @@index([created_at])

  @@map("users")
}

model ChatSession {
  session_id   String   @id @default(uuid()) @db.Uuid
  user_id      String?  @db.Uuid
  user_session_id String @db.VarChar(255)

  // Metadata
  session_start_time    DateTime @default(now()) @db.Timestamptz(6)
  session_end_time      DateTime? @db.Timestamptz(6)
  total_messages_count  Int      @default(0)
  session_duration_minutes Int?

  // Outcome
  session_completed   Boolean  @default(false)
  session_outcome     String?  @db.VarChar(100)
  final_step_reached  String?  @db.VarChar(50)

  // Device info
  user_agent   String? @db.Text
  ip_address   String? @db.Inet
  device_type  String? @db.VarChar(20)

  created_at   DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  user                  User?          @relation(fields: [user_id], references: [user_id])
  conversations         Conversation[]
  user_responses        UserResponse[]
  fpm_interactions      FpmInteraction[]
  user_clinic_referrals UserClinicReferral[]
  conversation_analytics ConversationAnalytics[]

  @@index([user_id])
  @@index([user_session_id])
  @@index([session_start_time])
}

model ChatStateSession {
  session_id      String   @id @default(uuid()) @db.Uuid
  user_session_id String   @unique @db.VarChar(255)

  // The actual chat state as JSON
  chat_state      String   @db.Text

  // Metadata
  last_activity   DateTime @default(now()) @db.Timestamptz(6)
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @updatedAt @db.Timestamptz(6)

  @@index([user_session_id])
  @@index([last_activity])
  @@map("chat_state_sessions")
}

model Conversation {
  conversation_id String   @id @default(uuid()) @db.Uuid
  session_id      String?  @db.Uuid
  user_id         String?  @db.Uuid

  message_text    String   @db.Text
  message_type    String   @db.VarChar(10)
  message_source  String?  @default("typed") @db.VarChar(20)

  chat_step        String? @db.VarChar(50)
  widget_name      String? @db.VarChar(100)
  selected_option  String? @db.VarChar(200)

  message_delay_ms Int?
  has_widget       Boolean @default(false)
  widget_options   String[] @db.Text

  created_at   DateTime @default(now()) @db.Timestamptz(6)
  message_sequence_number Int

  // Relations
  session        ChatSession? @relation(fields: [session_id], references: [session_id])
  user           User?        @relation(fields: [user_id], references: [user_id])
  user_responses UserResponse[]

  // New fields for agent system
  status            ConversationStatus @default(ACTIVE)
  escalatedAt       DateTime?          @map("escalated_at")
  escalationReason  String?            @map("escalation_reason")
  assignedAgentId   String?            @map("assigned_agent_id")
  assignedAt        DateTime?          @map("assigned_at")
  completedAt       DateTime?          @map("completed_at")
  satisfaction      SatisfactionLevel?
  satisfactionScore Float?             @map("satisfaction_score")
  feedback          String?            @db.Text
  responseTime      Float?             @map("response_time")

  // New relations
  assignments       ConversationAssignment[]
  queue             ConversationQueue?
  agentMessages     AgentMessage[]

  @@index([session_id, user_id])
  @@index([created_at])
  @@index([status])

  @@map("conversations")
}

model UserResponse {
  response_id     String   @id @default(uuid()) @db.Uuid
  user_id         String?  @db.Uuid
  session_id      String?  @db.Uuid
  conversation_id String?  @db.Uuid
  previous_response_id String? @db.Uuid

  response_category String @db.VarChar(50)
  response_type     String @db.VarChar(50)
  question_asked    String? @db.Text
  user_response     String  @db.Text
  response_value    String? @db.VarChar(200)
  widget_used       String? @db.VarChar(100)
  available_options String[] @db.Text
  step_in_flow      String? @db.VarChar(50)
  is_initial_response Boolean @default(true)
  created_at        DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  user               User?          @relation(fields: [user_id], references: [user_id])
  session            ChatSession?   @relation(fields: [session_id], references: [session_id])
  conversation       Conversation?  @relation(fields: [conversation_id], references: [conversation_id])
  previous_response  UserResponse?  @relation("UserResponseToPrevious", fields: [previous_response_id], references: [response_id])
  next_responses     UserResponse[] @relation("UserResponseToPrevious")
}

model FpmInteraction {
  interaction_id String @id @default(uuid()) @db.Uuid
  user_id        String? @db.Uuid
  session_id     String? @db.Uuid

  fpm_flow_type           String? @db.VarChar(50)
  current_fpm_method      String? @db.VarChar(100)
  interested_fpm_method   String? @db.VarChar(100)
  fpm_duration_preference String? @db.VarChar(50)

  contraception_type      String? @db.VarChar(50)
  emergency_product       String? @db.VarChar(50)
  prevention_duration     String? @db.VarChar(50)
  selected_method         String? @db.VarChar(100)

  satisfaction_level       String? @db.VarChar(50)
  switch_reason            String? @db.VarChar(200)
  stop_reason              String? @db.VarChar(200)
  important_factors        String[] @db.Text
  kids_in_future           String? @db.VarChar(20)
  timing_preference        String? @db.VarChar(50)
  menstrual_flow_preference String? @db.VarChar(100)

  provided_information  String? @db.Text
  next_action           String? @db.VarChar(100)
  clinic_referral_needed Boolean @default(false)
  human_agent_requested  Boolean @default(false)

  created_at DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  user    User?        @relation(fields: [user_id], references: [user_id])
  session ChatSession? @relation(fields: [session_id], references: [session_id])
}

model ClinicLocation {
  clinic_id String @id @default(uuid()) @db.Uuid
  clinic_name String @db.VarChar(200)
  clinic_type String? @db.VarChar(50)

  state   String @db.VarChar(100)
  lga     String @db.VarChar(100)
  city    String? @db.VarChar(100)
  address String? @db.Text
  landmark String? @db.VarChar(200)

  phone_number String? @db.VarChar(20)
  website      String? @db.VarChar(200)

  services_offered      String[] @db.Text
  fpm_methods_available String[] @db.Text
  consultation_fee      Decimal? @db.Decimal(10,2)
  operating_hours       String? @db.Text

  latitude  Decimal? @db.Decimal(10,8)
  longitude Decimal? @db.Decimal(11,8)

  is_active    Boolean @default(true)
  verified_at  DateTime? @db.Timestamptz(6)
  created_at   DateTime @default(now()) @db.Timestamptz(6)
  updated_at   DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  referrals UserClinicReferral[]
}

model UserClinicReferral {
  referral_id String @id @default(uuid()) @db.Uuid
  user_id     String? @db.Uuid
  session_id  String? @db.Uuid
  clinic_id   String? @db.Uuid

  referral_reason     String? @db.VarChar(200)
  user_concern        String? @db.VarChar(200)
  recommended_service String? @db.VarChar(100)

  referral_provided_at DateTime @default(now()) @db.Timestamptz(6)
  user_contacted_clinic Boolean @default(false)
  user_visited_clinic   Boolean @default(false)
  visit_confirmed_at    DateTime? @db.Timestamptz(6)

  follow_up_needed    Boolean @default(false)
  follow_up_completed Boolean @default(false)
  follow_up_notes     String? @db.Text

  // Relations
  user    User?          @relation(fields: [user_id], references: [user_id])
  session ChatSession?   @relation(fields: [session_id], references: [session_id])
  clinic  ClinicLocation? @relation(fields: [clinic_id], references: [clinic_id])
}

model ConversationAnalytics {
  analytics_id String @id @default(uuid()) @db.Uuid
  session_id   String?    @unique@db.Uuid
  user_id      String? @db.Uuid

  steps_completed         String[] @db.Text
  widgets_interacted_with String[] @db.Text
  flows_attempted         String[] @db.Text

  total_user_messages    Int @default(0)
  total_bot_messages     Int @default(0)
  total_button_clicks    Int @default(0)
  total_typed_responses  Int @default(0)
  session_abandonment_point String? @db.VarChar(50)

  information_provided   String[] @db.Text
  goals_achieved         String[] @db.Text
  unresolved_concerns    String[] @db.Text
  satisfaction_rating    Int?

  average_response_time_seconds Decimal? @db.Decimal(10,2)
  errors_encountered            String[] @db.Text

  created_at DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  user    User?        @relation(fields: [user_id], references: [user_id])
  session ChatSession? @relation(fields: [session_id], references: [session_id])
}

// admin & agent
model Admin {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @db.VarChar(100)
  email     String   @unique @db.VarChar(255)
  password  String   @db.VarChar(255) // Hash this in your auth service
  role      AdminRole @default(ADMIN)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Track configuration changes
  configChanges ChatbotConfig[] @relation("ConfigUpdatedBy")

  @@map("admins")
}

model Agent {
  id            String   @id @default(uuid()) @db.Uuid
  name          String   @db.VarChar(100)
  email         String   @unique @db.VarChar(255)
  password      String   @db.VarChar(255) // Hash this in your auth service
  status        AgentStatus @default(OFFLINE)
  maxChats      Int      @default(5) @map("max_chats")
  currentChats  Int      @default(0) @map("current_chats")
  isOnline      Boolean  @default(false) @map("is_online")
  lastActiveAt  DateTime? @map("last_active_at") @db.Timestamptz(6)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  assignedConversations ConversationAssignment[]
  sentMessages          AgentMessage[]

  @@map("agents")
}


// CONVERSATION ASSIGNMENT & QUEUE SYSTEM


model ConversationAssignment {
  id             String       @id @default(uuid()) @db.Uuid
  conversationId String       @map("conversation_id") @db.Uuid
  agentId        String       @map("agent_id") @db.Uuid
  assignedAt     DateTime     @default(now()) @map("assigned_at")
  completedAt    DateTime?    @map("completed_at")
  status         AssignmentStatus @default(ACTIVE)
  priority       Priority     @default(NORMAL)

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [conversation_id])
  agent          Agent        @relation(fields: [agentId], references: [id])

  @@map("conversation_assignments")
}

model ConversationQueue {
  id             String    @id @default(uuid()) @db.Uuid
  conversationId String    @unique @map("conversation_id") @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  priority       Priority  @default(NORMAL)
  queuedAt       DateTime  @default(now()) @map("queued_at")
  estimatedWait  Int?      @map("estimated_wait_minutes")
  status         QueueStatus @default(WAITING)

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [conversation_id])
  user           User         @relation(fields: [userId], references: [user_id])

  @@map("conversation_queue")
}


// AGENT MESSAGING SYSTEM


model AgentMessage {
  id             String    @id @default(uuid()) @db.Uuid
  conversationId String    @map("conversation_id") @db.Uuid
  agentId        String    @map("agent_id") @db.Uuid
  messageText    String    @map("message_text") @db.Text
  sentAt         DateTime  @default(now()) @map("sent_at") @db.Timestamptz(6)
  isRead         Boolean   @default(false) @map("is_read")
  readAt         DateTime? @map("read_at") @db.Timestamptz(6)

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [conversation_id])
  agent          Agent        @relation(fields: [agentId], references: [id])

  @@map("agent_messages")
}


// DYNAMIC CONFIGURATION SYSTEM


model ChatbotConfig {
  id        String   @id @default(uuid()) @db.Uuid
  key       String   @unique @db.VarChar(255)
  value     String   @db.Text
  category  ConfigCategory
  language  String   @default("en") @db.VarChar(10)
  updatedBy String?  @map("updated_by") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  updatedByAdmin Admin? @relation("ConfigUpdatedBy", fields: [updatedBy], references: [id])

  @@map("chatbot_config")
}


// ENUMS
enum AdminRole {
  SUPER_ADMIN
  ADMIN
  MODERATOR
}

enum AgentStatus {
  ONLINE
  OFFLINE
  BUSY
  AWAY
}

enum AssignmentStatus {
  ACTIVE
  COMPLETED
  TRANSFERRED
  ABANDONED
}

enum QueueStatus {
  WAITING
  ASSIGNED
  CANCELLED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum ConversationStatus {
  ACTIVE
  WAITING_FOR_AGENT
  AGENT_ASSIGNED
  RESOLVED
  COMPLETED
  ABANDONED
}

enum SatisfactionLevel {
  VERY_SATISFIED
  SATISFIED
  NEUTRAL
  DISSATISFIED
  VERY_DISSATISFIED
}

enum ConfigCategory {
  MESSAGES
  OPTIONS
  SYSTEM
  UI_TEXT
  PROMPTS
}
